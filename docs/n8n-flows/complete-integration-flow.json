{
  "meta": {
    "instanceId": "poupeja-integration"
  },
  "name": "PoupeJÃ¡ - IntegraÃ§Ã£o Completa N8N + Supabase + Evolution API",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "poupeja-complete",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "ğŸ“¥ Webhook PoupeJÃ¡",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "poupeja-complete-webhook"
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.all()[0].json;\n\nfunction normalizePhone(phone) {\n  if (!phone) return null;\n  let cleanPhone = phone.replace(/\\D/g, '');\n  if (cleanPhone.startsWith('55') && cleanPhone.length > 11) {\n    cleanPhone = cleanPhone.substring(2);\n  }\n  if (cleanPhone.length === 10) {\n    cleanPhone = cleanPhone.substring(0, 2) + '9' + cleanPhone.substring(2);\n  }\n  if (cleanPhone.length === 11) {\n    cleanPhone = '55' + cleanPhone;\n  }\n  return cleanPhone;\n}\n\nfunction buildMessage(event, data, user) {\n  const userName = user?.name || 'UsuÃ¡rio';\n  const dataTitle = data?.title || 'Dados';\n  const messages = {\n    appointment_created: `ğŸ—“ï¸ *Compromisso Agendado*\\n\\nOlÃ¡ ${userName}!\\n\\nğŸ“… **${dataTitle}**\\nğŸ“† Data: ${data?.date ? new Date(data.date).toLocaleDateString('pt-BR') : 'NÃ£o informado'}\\n\\nâœ… Compromisso registrado!`,\n    transaction_due: `ğŸ’° *Lembrete de Pagamento*\\n\\nOlÃ¡ ${userName}!\\n\\nğŸ’¸ **${dataTitle}**\\nğŸ’µ Valor: R$ ${data?.amount ? Number(data.amount).toFixed(2) : '0,00'}\\nğŸ“… Vencimento: ${data?.date ? new Date(data.date).toLocaleDateString('pt-BR') : 'NÃ£o informado'}\\n\\nâ° NÃ£o esqueÃ§a!`,\n    goal_progress: `ğŸ¯ *Progresso da Meta*\\n\\nOlÃ¡ ${userName}!\\n\\nğŸ† **${dataTitle}**\\nğŸ’° Atual: R$ ${data?.amount ? Number(data.amount).toFixed(2) : '0,00'}\\nğŸ“Š Progresso: ${data?.metadata?.progress_percent || 0}%`,\n    budget_exceeded: `âš ï¸ *OrÃ§amento Excedido*\\n\\nOlÃ¡ ${userName}!\\n\\nğŸ“Š **${dataTitle}**\\nğŸ’¸ Excesso: R$ ${data?.amount ? Number(data.amount).toFixed(2) : '0,00'}`\n  };\n  return messages[event] || `ğŸ“± PoupeJÃ¡\\n\\nOlÃ¡ ${userName}!\\n\\n${dataTitle}`;\n}\n\n// ValidaÃ§Ã£o de dados de entrada\nif (!inputData || typeof inputData !== 'object') {\n  throw new Error('Dados de entrada invÃ¡lidos');\n}\n\nconst event = inputData.event || 'unknown';\nconst user = inputData.user || {};\nconst data = inputData.data || {};\nconst automationRules = inputData.automationRules || {};\n\n// ValidaÃ§Ã£o adicional para user\nif (!user.name) {\n  user.name = 'UsuÃ¡rio';\n}\n\nconst normalizedPhone = normalizePhone(user.phone);\n\nconst processedData = {\n  event,\n  user: { ...user, phone: normalizedPhone },\n  data,\n  automationRules,\n  message: buildMessage(event, data, user),\n  shouldSendWhatsApp: automationRules.sendWhatsApp !== false && normalizedPhone\n};\n\nreturn [processedData];"
      },
      "id": "process-data",
      "name": "âš™ï¸ Processar Dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-whatsapp",
              "leftValue": "={{ $json.shouldSendWhatsApp }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "check-whatsapp",
      "name": "ğŸ“± Enviar WhatsApp?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "url": "https://EVOLUTION_API_URL/message/sendText/INSTANCIA",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "COLE_SUA_API_KEY_AQUI"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $json.user.phone }}"
            },
            {
              "name": "text",
              "value": "={{ $json.message }}"
            }
          ]
        }
      },
      "id": "send-whatsapp",
      "name": "ğŸ“¨ Enviar WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [900, 180]
    },
    {
      "parameters": {
        "jsCode": "// Log simples no console\nconsole.log('WhatsApp enviado para:', $json.user.name);\nconsole.log('Evento:', $json.event);\nconsole.log('Telefone:', $json.user.phone);\n\nreturn [$json];"
      },
      "id": "log-success",
      "name": "ğŸ“Š Log Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 420]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true, \"message\": \"AutomaÃ§Ã£o executada\", \"event\": \"{{ $json.event }}\", \"user\": \"{{ $json.user.name }}\" }",
        "options": {}
      },
      "id": "success-response",
      "name": "âœ… Resposta Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"message\": \"WhatsApp ignorado\", \"event\": \"{{ $json.event }}\" }",
        "options": {},
        "httpCode": 200
      },
      "id": "skip-response",
      "name": "â­ï¸ WhatsApp Ignorado",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [900, 580]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"message\": \"Erro na automaÃ§Ã£o\" }",
        "options": {},
        "httpCode": 500
      },
      "id": "error-response",
      "name": "âŒ Resposta Erro",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [680, 580]
    }
  ],
  "connections": {
    "ğŸ“¥ Webhook PoupeJÃ¡": {
      "main": [
        [
          {
            "node": "âš™ï¸ Processar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ Processar Dados": {
      "main": [
        [
          {
            "node": "ğŸ“± Enviar WhatsApp?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“± Enviar WhatsApp?": {
      "main": [
        [
          {
            "node": "ğŸ“¨ Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â­ï¸ WhatsApp Ignorado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¨ Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "ğŸ“Š Log Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Log Sucesso": {
      "main": [
        [
          {
            "node": "âœ… Resposta Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": 1
}