{
  "name": "PoupeJÃ¡ - IntegraÃ§Ã£o Completa N8N + Supabase + Evolution API",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "poupeja-complete",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "ğŸ“¥ Webhook PoupeJÃ¡",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "poupeja-complete-webhook"
    },
    {
      "parameters": {
        "jsCode": "// Processar dados do PoupeJÃ¡\nconst inputData = $input.all()[0].json;\n\nconsole.log('Dados recebidos:', JSON.stringify(inputData, null, 2));\n\n// Extrair informaÃ§Ãµes\nconst {\n  event,\n  user,\n  data,\n  automationRules = {},\n  config = {}\n} = inputData;\n\n// Normalizar telefone brasileiro\nfunction normalizePhone(phone) {\n  if (!phone) return null;\n  \n  let cleanPhone = phone.replace(/\\D/g, '');\n  \n  // Remove cÃ³digo do paÃ­s (55) se presente\n  if (cleanPhone.startsWith('55') && cleanPhone.length > 11) {\n    cleanPhone = cleanPhone.substring(2);\n  }\n  \n  // Adiciona o 9 se for celular e nÃ£o tiver\n  if (cleanPhone.length === 10 && ['11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '24', '27', '28'].includes(cleanPhone.substring(0, 2))) {\n    cleanPhone = cleanPhone.substring(0, 2) + '9' + cleanPhone.substring(2);\n  }\n  \n  // Adiciona cÃ³digo do paÃ­s\n  if (cleanPhone.length === 11) {\n    cleanPhone = '55' + cleanPhone;\n  }\n  \n  return cleanPhone;\n}\n\n// Construir mensagem personalizada\nfunction buildMessage(event, data, user) {\n  const messages = {\n    appointment_created: `ğŸ—“ï¸ *Compromisso Agendado*\\n\\nOlÃ¡ ${user.name}!\\n\\nğŸ“… **${data.title}**\\n${data.description ? 'ğŸ“ ' + data.description + '\\n' : ''}ğŸ“† Data: ${new Date(data.date).toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}\\n\\nâœ… Seu compromisso foi registrado com sucesso!`,\n    \n    transaction_due: `ğŸ’° *Lembrete de Pagamento*\\n\\nOlÃ¡ ${user.name}!\\n\\nğŸ’¸ **${data.title}**\\nğŸ’µ Valor: R$ ${Number(data.amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\\nğŸ“… Vencimento: ${new Date(data.date).toLocaleDateString('pt-BR')}\\n\\nâ° NÃ£o esqueÃ§a de fazer seu pagamento!`,\n    \n    goal_progress: `ğŸ¯ *Progresso da Meta*\\n\\nOlÃ¡ ${user.name}!\\n\\nğŸ† **${data.title}**\\nğŸ’° Valor atual: R$ ${Number(data.amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\\nğŸ¯ Meta: R$ ${Number(data.metadata.target_amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\\nğŸ“Š Progresso: ${data.metadata.progress_percent.toFixed(1)}%\\n\\n${data.metadata.progress_percent >= 90 ? 'ğŸ‰ ParabÃ©ns! VocÃª estÃ¡ quase lÃ¡!' : 'ğŸ’ª Continue assim, vocÃª estÃ¡ no caminho certo!'}`,\n    \n    budget_exceeded: `âš ï¸ *OrÃ§amento Excedido*\\n\\nOlÃ¡ ${user.name}!\\n\\nğŸ“Š **${data.title}**\\nğŸ’° OrÃ§amento: R$ ${Number(data.metadata.budget_amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\\nğŸ’¸ Gasto: R$ ${Number(data.metadata.spent_amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\\nğŸ“ˆ Excesso: R$ ${Number(data.amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\\n\\nğŸ’¡ Que tal revisar seus gastos este mÃªs?`,\n    \n    payment_reminder: `ğŸ”” *Lembrete de Pagamento*\\n\\nOlÃ¡ ${user.name}!\\n\\nğŸ’³ **${data.title}**\\nğŸ’° Valor: R$ ${Number(data.amount).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}\\nğŸ“… Vence em: ${data.metadata?.days_until || '1'} dia(s)\\n\\nâ° NÃ£o deixe para a Ãºltima hora!`\n  };\n  \n  return messages[event] || `ğŸ“± *PoupeJÃ¡*\\n\\nOlÃ¡ ${user.name}!\\n\\n${data.title}\\n${data.description || ''}\\n\\nObrigado por usar o PoupeJÃ¡!`;\n}\n\n// Processar dados\nconst processedData = {\n  event,\n  user: {\n    ...user,\n    phone: normalizePhone(user.phone)\n  },\n  data,\n  automationRules,\n  message: buildMessage(event, data, user),\n  evolutionApi: {\n    instance: config.evolutionApi?.instance || 'poupeja-instance',\n    apiUrl: config.evolutionApi?.apiUrl || 'https://evolution-api.com'\n  },\n  timestamp: new Date().toISOString(),\n  shouldSendWhatsApp: automationRules.sendWhatsApp !== false && user.phone\n};\n\nconsole.log('Dados processados:', JSON.stringify(processedData, null, 2));\n\nreturn [processedData];"
      },
      "id": "process-data",
      "name": "âš™ï¸ Processar Dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-whatsapp",
              "leftValue": "={{ $json.shouldSendWhatsApp }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "check-whatsapp",
      "name": "ğŸ“± Enviar WhatsApp?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "url": "={{ $json.evolutionApi.apiUrl }}/message/sendText/{{ $json.evolutionApi.instance }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "COLE_SUA_API_KEY_AQUI"
            }\n          ]\n        },\n        \"sendBody\": true,\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"number\",\n              \"value\": \"={{ $json.user.phone }}\"\n            },\n            {\n              \"name\": \"text\",\n              \"value\": \"={{ $json.message }}\"\n            }\n          ]\n        },\n        \"options\": {\n          \"timeout\": 10000\n        }\n      },\n      \"id\": \"send-whatsapp\",\n      \"name\": \"ğŸ“¨ Enviar WhatsApp\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4.2,\n      \"position\": [900, 180]\n    },\n    {\n      \"parameters\": {\n        \"authentication\": \"serviceAccount\",\n        \"operation\": \"insert\",\n        \"tableId\": \"poupeja_automation_logs\",\n        \"columnToMatchOn\": \"id\",\n        \"valuesToSend\": {\n          \"values\": [\n            {\n              \"column\": \"user_id\",\n              \"value\": \"={{ $json.user.id }}\"\n            },\n            {\n              \"column\": \"event_type\",\n              \"value\": \"={{ $json.event }}\"\n            },\n            {\n              \"column\": \"data\",\n              \"value\": \"={{ JSON.stringify($json.data) }}\"\n            },\n            {\n              \"column\": \"status\",\n              \"value\": \"sent\"\n            },\n            {\n              \"column\": \"created_at\",\n              \"value\": \"={{ $json.timestamp }}\"\n            }\n          ]\n        }\n      },\n      \"id\": \"log-supabase\",\n      \"name\": \"ğŸ“Š Log no Supabase\",\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"typeVersion\": 1,\n      \"position\": [900, 420]\n    },\n    {\n      \"parameters\": {\n        \"respondWith\": \"json\",\n        \"responseBody\": \"={ \\\"success\\\": true, \\\"message\\\": \\\"AutomaÃ§Ã£o executada com sucesso\\\", \\\"event\\\": \\\"{{ $json.event }}\\\", \\\"user\\\": \\\"{{ $json.user.name }}\\\", \\\"whatsapp_sent\\\": {{ $json.shouldSendWhatsApp }}, \\\"timestamp\\\": \\\"{{ $json.timestamp }}\\\" }\",\n        \"options\": {}\n      },\n      \"id\": \"success-response\",\n      \"name\": \"âœ… Resposta Sucesso\",\n      \"type\": \"n8n-nodes-base.respondToWebhook\",\n      \"typeVersion\": 1,\n      \"position\": [1120, 300]\n    },\n    {\n      \"parameters\": {\n        \"respondWith\": \"json\",\n        \"responseBody\": \"={ \\\"success\\\": false, \\\"message\\\": \\\"WhatsApp nÃ£o enviado\\\", \\\"reason\\\": \\\"CondiÃ§Ãµes nÃ£o atendidas\\\", \\\"event\\\": \\\"{{ $json.event }}\\\", \\\"user\\\": \\\"{{ $json.user.name }}\\\", \\\"timestamp\\\": \\\"{{ $json.timestamp }}\\\" }\",\n        \"options\": {},\n        \"httpCode\": 200\n      },\n      \"id\": \"skip-response\",\n      \"name\": \"â­ï¸ WhatsApp Ignorado\",\n      \"type\": \"n8n-nodes-base.respondToWebhook\",\n      \"typeVersion\": 1,\n      \"position\": [900, 580]\n    },\n    {\n      \"parameters\": {\n        \"respondWith\": \"json\",\n        \"responseBody\": \"={ \\\"success\\\": false, \\\"message\\\": \\\"Erro na automaÃ§Ã£o\\\", \\\"error\\\": \\\"{{ $json.error.message }}\\\", \\\"timestamp\\\": \\\"{{ new Date().toISOString() }}\\\" }\",\n        \"options\": {},\n        \"httpCode\": 500\n      },\n      \"id\": \"error-response\",\n      \"name\": \"âŒ Resposta Erro\",\n      \"type\": \"n8n-nodes-base.respondToWebhook\",\n      \"typeVersion\": 1,\n      \"position\": [680, 580]\n    }\n  ],\n  \"connections\": {\n    \"ğŸ“¥ Webhook PoupeJÃ¡\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"âš™ï¸ Processar Dados\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"âš™ï¸ Processar Dados\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"ğŸ“± Enviar WhatsApp?\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"ğŸ“± Enviar WhatsApp?\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"ğŸ“¨ Enviar WhatsApp\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"â­ï¸ WhatsApp Ignorado\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"ğŸ“¨ Enviar WhatsApp\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"ğŸ“Š Log no Supabase\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"ğŸ“Š Log no Supabase\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"âœ… Resposta Sucesso\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"pinData\": {},\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"staticData\": null,\n  \"tags\": [\n    {\n      \"createdAt\": \"2024-01-01T00:00:00.000Z\",\n      \"updatedAt\": \"2024-01-01T00:00:00.000Z\",\n      \"id\": \"poupeja-integration\",\n      \"name\": \"PoupeJÃ¡ Integration\"\n    }\n  ],\n  \"triggerCount\": 1,\n  \"updatedAt\": \"2024-01-01T00:00:00.000Z\",\n  \"versionId\": \"complete-integration-v1\"\n}