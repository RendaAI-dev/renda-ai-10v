{
  "meta": {
    "instanceId": "poupeja-integration"
  },
  "name": "PoupeJá - Integração Completa N8N + Supabase + Evolution API",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "poupeja-complete",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "📥 Webhook PoupeJá",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "poupeja-complete-webhook"
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.all()[0].json;\n\nfunction normalizePhone(phone) {\n  if (!phone) return null;\n  let cleanPhone = phone.replace(/\\D/g, '');\n  if (cleanPhone.startsWith('55') && cleanPhone.length > 11) {\n    cleanPhone = cleanPhone.substring(2);\n  }\n  if (cleanPhone.length === 10) {\n    cleanPhone = cleanPhone.substring(0, 2) + '9' + cleanPhone.substring(2);\n  }\n  if (cleanPhone.length === 11) {\n    cleanPhone = '55' + cleanPhone;\n  }\n  return cleanPhone;\n}\n\nfunction buildMessage(event, data, user) {\n  const userName = user?.name || 'Usuário';\n  const dataTitle = data?.title || 'Dados';\n  const messages = {\n    appointment_created: `🗓️ *Compromisso Agendado*\\n\\nOlá ${userName}!\\n\\n📅 **${dataTitle}**\\n📆 Data: ${data?.date ? new Date(data.date).toLocaleDateString('pt-BR') : 'Não informado'}\\n\\n✅ Compromisso registrado!`,\n    transaction_due: `💰 *Lembrete de Pagamento*\\n\\nOlá ${userName}!\\n\\n💸 **${dataTitle}**\\n💵 Valor: R$ ${data?.amount ? Number(data.amount).toFixed(2) : '0,00'}\\n📅 Vencimento: ${data?.date ? new Date(data.date).toLocaleDateString('pt-BR') : 'Não informado'}\\n\\n⏰ Não esqueça!`,\n    goal_progress: `🎯 *Progresso da Meta*\\n\\nOlá ${userName}!\\n\\n🏆 **${dataTitle}**\\n💰 Atual: R$ ${data?.amount ? Number(data.amount).toFixed(2) : '0,00'}\\n📊 Progresso: ${data?.metadata?.progress_percent || 0}%`,\n    budget_exceeded: `⚠️ *Orçamento Excedido*\\n\\nOlá ${userName}!\\n\\n📊 **${dataTitle}**\\n💸 Excesso: R$ ${data?.amount ? Number(data.amount).toFixed(2) : '0,00'}`\n  };\n  return messages[event] || `📱 PoupeJá\\n\\nOlá ${userName}!\\n\\n${dataTitle}`;\n}\n\n// Validação de dados de entrada\nif (!inputData || typeof inputData !== 'object') {\n  throw new Error('Dados de entrada inválidos');\n}\n\nconst event = inputData.event || 'unknown';\nconst user = inputData.user || {};\nconst data = inputData.data || {};\nconst automationRules = inputData.automationRules || {};\n\n// Validação adicional para user\nif (!user.name) {\n  user.name = 'Usuário';\n}\n\nconst normalizedPhone = normalizePhone(user.phone);\n\nconst processedData = {\n  event,\n  user: { ...user, phone: normalizedPhone },\n  data,\n  automationRules,\n  message: buildMessage(event, data, user),\n  shouldSendWhatsApp: automationRules.sendWhatsApp !== false && normalizedPhone\n};\n\nreturn [processedData];"
      },
      "id": "process-data",
      "name": "⚙️ Processar Dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-whatsapp",
              "leftValue": "={{ $json.shouldSendWhatsApp }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "check-whatsapp",
      "name": "📱 Enviar WhatsApp?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "url": "https://EVOLUTION_API_URL/message/sendText/INSTANCIA",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "COLE_SUA_API_KEY_AQUI"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $json.user.phone }}"
            },
            {
              "name": "text",
              "value": "={{ $json.message }}"
            }
          ]
        }
      },
      "id": "send-whatsapp",
      "name": "📨 Enviar WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [900, 180]
    },
    {
      "parameters": {
        "jsCode": "// Log simples no console\nconsole.log('WhatsApp enviado para:', $json.user.name);\nconsole.log('Evento:', $json.event);\nconsole.log('Telefone:', $json.user.phone);\n\nreturn [$json];"
      },
      "id": "log-success",
      "name": "📊 Log Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 420]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true, \"message\": \"Automação executada\", \"event\": \"{{ $json.event }}\", \"user\": \"{{ $json.user.name }}\" }",
        "options": {}
      },
      "id": "success-response",
      "name": "✅ Resposta Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"message\": \"WhatsApp ignorado\", \"event\": \"{{ $json.event }}\" }",
        "options": {},
        "httpCode": 200
      },
      "id": "skip-response",
      "name": "⏭️ WhatsApp Ignorado",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [900, 580]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"message\": \"Erro na automação\" }",
        "options": {},
        "httpCode": 500
      },
      "id": "error-response",
      "name": "❌ Resposta Erro",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [680, 580]
    }
  ],
  "connections": {
    "📥 Webhook PoupeJá": {
      "main": [
        [
          {
            "node": "⚙️ Processar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "⚙️ Processar Dados": {
      "main": [
        [
          {
            "node": "📱 Enviar WhatsApp?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📱 Enviar WhatsApp?": {
      "main": [
        [
          {
            "node": "📨 Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "⏭️ WhatsApp Ignorado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📨 Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "📊 Log Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📊 Log Sucesso": {
      "main": [
        [
          {
            "node": "✅ Resposta Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": 1
}