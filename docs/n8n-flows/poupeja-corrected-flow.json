{
  "name": "PoupeJÃ¡ - Fluxo Corrigido (Evolution API + WhatsApp)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "poupeja-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "ğŸ¯ Webhook PoupeJÃ¡",
      "type": "n8n-nodes-base.webhookTrigger",
      "typeVersion": 1,
      "position": [280, 300],
      "webhookId": "poupeja-webhook"
    },
    {
      "parameters": {
        "jsCode": "// ===== PROCESSAMENTO CORRIGIDO DE DADOS POUPEJÃ =====\n\n// FunÃ§Ã£o para normalizar telefone brasileiro\nfunction normalizePhone(phone) {\n  if (!phone) {\n    console.log('âŒ Telefone nÃ£o fornecido');\n    return null;\n  }\n  \n  // Remove todos os caracteres nÃ£o numÃ©ricos\n  let cleanPhone = phone.toString().replace(/\\D/g, '');\n  console.log(`ğŸ“± Telefone original: ${phone}, limpo: ${cleanPhone}`);\n  \n  // Remove cÃ³digo do paÃ­s 55 se presente no inÃ­cio\n  if (cleanPhone.startsWith('55') && cleanPhone.length > 11) {\n    cleanPhone = cleanPhone.substring(2);\n    console.log(`ğŸ‡§ğŸ‡· Removido cÃ³digo 55: ${cleanPhone}`);\n  }\n  \n  // Adiciona nono dÃ­gito se necessÃ¡rio (DDD + 8 dÃ­gitos = 10 total)\n  if (cleanPhone.length === 10) {\n    // Adiciona 9 apÃ³s o DDD para celulares\n    cleanPhone = cleanPhone.substring(0, 2) + '9' + cleanPhone.substring(2);\n    console.log(`ğŸ“± Adicionado 9Âº dÃ­gito: ${cleanPhone}`);\n  }\n  \n  // Adiciona cÃ³digo do paÃ­s\n  if (cleanPhone.length === 11) {\n    cleanPhone = '55' + cleanPhone;\n    console.log(`ğŸŒ Adicionado cÃ³digo do paÃ­s: ${cleanPhone}`);\n  }\n  \n  // ValidaÃ§Ã£o final\n  if (cleanPhone.length !== 13) {\n    console.log(`âŒ Telefone invÃ¡lido apÃ³s normalizaÃ§Ã£o: ${cleanPhone} (${cleanPhone.length} dÃ­gitos)`);\n    return null;\n  }\n  \n  console.log(`âœ… Telefone normalizado com sucesso: ${cleanPhone}`);\n  return cleanPhone;\n}\n\n// FunÃ§Ã£o para construir mensagem WhatsApp\nfunction buildWhatsAppMessage(data) {\n  const { type, user, data: eventData, message } = data;\n  const userName = user?.name || 'UsuÃ¡rio';\n  \n  console.log(`ğŸ“ Construindo mensagem para evento: ${type}`);\n  \n  // Se jÃ¡ tiver mensagem pronta, usar ela\n  if (message) {\n    console.log('ğŸ’¬ Usando mensagem prÃ©-definida');\n    return message;\n  }\n  \n  // Construir mensagem baseada no tipo de evento\n  switch (type) {\n    case 'appointment_reminder':\n    case 'appointment_created':\n      if (eventData?.title) {\n        const date = eventData.date ? new Date(eventData.date).toLocaleDateString('pt-BR') : 'Data nÃ£o informada';\n        const time = eventData.date ? new Date(eventData.date).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';\n        return `ğŸ—“ï¸ *Lembrete de Compromisso*\\n\\nOlÃ¡ ${userName}!\\n\\nğŸ“… **${eventData.title}**\\nğŸ• ${date}${time ? ` Ã s ${time}` : ''}\\n${eventData.location ? `ğŸ“ ${eventData.location}` : ''}\\n\\nğŸ’¡ *PoupeJÃ¡ - Seu Organizador Pessoal*`;\n      }\n      break;\n      \n    case 'transaction_reminder':\n    case 'transaction_due':\n      if (eventData?.title) {\n        const amount = eventData.amount ? `R$ ${Number(eventData.amount).toFixed(2).replace('.', ',')}` : '';\n        const date = eventData.date ? new Date(eventData.date).toLocaleDateString('pt-BR') : 'Data nÃ£o informada';\n        return `ğŸ’° *Lembrete Financeiro*\\n\\nOlÃ¡ ${userName}!\\n\\nğŸ“ **${eventData.title}**\\n${amount ? `ğŸ’µ ${amount}` : ''}\\nğŸ“… Vencimento: ${date}\\n${eventData.description ? `ğŸ“‹ ${eventData.description}` : ''}\\n\\nğŸ’¡ *PoupeJÃ¡ - Seu Assistente Financeiro*`;\n      }\n      break;\n      \n    case 'goal_progress':\n    case 'goal_achieved':\n      if (eventData?.title) {\n        const current = eventData.amount ? `R$ ${Number(eventData.amount).toFixed(2).replace('.', ',')}` : 'R$ 0,00';\n        const progress = eventData.metadata?.progress_percent || 0;\n        return `ğŸ¯ *Progresso da Meta*\\n\\nOlÃ¡ ${userName}!\\n\\nğŸ† **${eventData.title}**\\nğŸ’° Valor atual: ${current}\\nğŸ“Š Progresso: ${progress}%\\n\\n${type === 'goal_achieved' ? 'ğŸ‰ **PARABÃ‰NS! Meta atingida!**' : 'â­ Continue assim!'}\\n\\nğŸ’¡ *PoupeJÃ¡ - Seus Objetivos*`;\n      }\n      break;\n      \n    case 'budget_exceeded':\n      if (eventData?.title) {\n        const exceeded = eventData.amount ? `R$ ${Number(eventData.amount).toFixed(2).replace('.', ',')}` : 'R$ 0,00';\n        return `âš ï¸ *OrÃ§amento Excedido*\\n\\nOlÃ¡ ${userName}!\\n\\nğŸ“Š **${eventData.title}**\\nğŸ’¸ Valor excedido: ${exceeded}\\nğŸ“ˆ Revise seus gastos para o perÃ­odo.\\n\\nğŸ’¡ *PoupeJÃ¡ - Controle Financeiro*`;\n      }\n      break;\n      \n    case 'custom':\n    default:\n      const title = eventData?.title || 'NotificaÃ§Ã£o';\n      const description = eventData?.description || 'VocÃª tem uma nova notificaÃ§Ã£o do PoupeJÃ¡.';\n      return `ğŸ“± *${title}*\\n\\nOlÃ¡ ${userName}!\\n\\n${description}\\n\\nğŸ’¡ *PoupeJÃ¡*`;\n  }\n  \n  // Fallback se nÃ£o conseguir construir mensagem especÃ­fica\n  return `ğŸ“± *NotificaÃ§Ã£o PoupeJÃ¡*\\n\\nOlÃ¡ ${userName}!\\n\\nVocÃª tem uma nova notificaÃ§Ã£o.\\n\\nğŸ’¡ *PoupeJÃ¡*`;\n}\n\n// ===== PROCESSAMENTO PRINCIPAL =====\n\ntry {\n  // Pegar dados do webhook\n  const webhookData = $input.first().body;\n  console.log('ğŸ“¥ Dados recebidos:', JSON.stringify(webhookData, null, 2));\n  \n  // ValidaÃ§Ã£o bÃ¡sica\n  if (!webhookData || typeof webhookData !== 'object') {\n    throw new Error('Dados do webhook invÃ¡lidos ou ausentes');\n  }\n  \n  // Extrair informaÃ§Ãµes principais\n  const { type, user, data: eventData, message, metadata } = webhookData;\n  \n  if (!user) {\n    throw new Error('InformaÃ§Ãµes do usuÃ¡rio nÃ£o fornecidas');\n  }\n  \n  console.log(`ğŸ‘¤ UsuÃ¡rio: ${user.name || 'Nome nÃ£o informado'} (${user.email || 'Email nÃ£o informado'})`);\n  console.log(`ğŸ“ Telefone original: ${user.phone || 'NÃ£o informado'}`);\n  \n  // Normalizar telefone\n  const normalizedPhone = normalizePhone(user.phone);\n  \n  if (!normalizedPhone) {\n    console.log('âŒ Telefone invÃ¡lido - WhatsApp serÃ¡ ignorado');\n    return {\n      success: false,\n      error: 'Telefone invÃ¡lido',\n      phone: user.phone,\n      shouldSend: false,\n      user: user,\n      type: type\n    };\n  }\n  \n  // Construir mensagem\n  const whatsappMessage = buildWhatsAppMessage(webhookData);\n  console.log('ğŸ’¬ Mensagem construÃ­da:', whatsappMessage.substring(0, 100) + '...');\n  \n  // ConfiguraÃ§Ãµes da Evolution API (usar do metadata se disponÃ­vel)\n  const evolutionConfig = {\n    apiUrl: metadata?.evolutionApi?.apiUrl || 'https://sua-evolution-api.com',\n    apiKey: metadata?.evolutionApi?.apiKey || 'sua-api-key-aqui',\n    instance: metadata?.evolutionApi?.instance || 'sua-instancia'\n  };\n  \n  console.log(`ğŸ”§ ConfiguraÃ§Ã£o Evolution API: ${evolutionConfig.apiUrl}/${evolutionConfig.instance}`);\n  \n  // Resultado final\n  const result = {\n    success: true,\n    shouldSend: true,\n    phone: normalizedPhone,\n    message: whatsappMessage,\n    user: {\n      ...user,\n      phone: normalizedPhone\n    },\n    type: type || 'unknown',\n    evolutionConfig: evolutionConfig,\n    originalData: webhookData,\n    timestamp: new Date().toISOString()\n  };\n  \n  console.log('âœ… Processamento concluÃ­do com sucesso');\n  return result;\n  \n} catch (error) {\n  console.log('âŒ Erro no processamento:', error.message);\n  console.log('ğŸ” Stack trace:', error.stack);\n  \n  return {\n    success: false,\n    error: error.message,\n    shouldSend: false,\n    timestamp: new Date().toISOString(),\n    originalData: $input.first().body\n  };\n}"
      },
      "id": "process-data",
      "name": "âš™ï¸ Processar Dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [520, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-success",
              "leftValue": "={{ $json.success }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            },
            {
              "id": "condition-send",
              "leftValue": "={{ $json.shouldSend }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "validate-data",
      "name": "âœ… Dados VÃ¡lidos?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [760, 300]
    },
    {
      "parameters": {
        "url": "={{ $json.evolutionConfig.apiUrl }}/message/sendText/{{ $json.evolutionConfig.instance }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "={{ $json.evolutionConfig.apiKey }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={\\n  \"number\": $json.phone,\\n  \"textMessage\": {\\n    \"text\": $json.message\\n  }\\n}",
        "options": {
          "timeout": 30000,
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "send-whatsapp",
      "name": "ğŸ“² Enviar WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1000, 200]
    },
    {
      "parameters": {
        "jsCode": "// Log de sucesso detalhado\nconst data = $input.first().json;\n\nconsole.log('ğŸ‰ SUCESSO - WhatsApp enviado!');\nconsole.log(`ğŸ‘¤ UsuÃ¡rio: ${data.user?.name}`);\nconsole.log(`ğŸ“ Telefone: ${data.phone}`);\nconsole.log(`ğŸ“§ Email: ${data.user?.email}`);\nconsole.log(`ğŸ“… Tipo: ${data.type}`);\nconsole.log(`â° Timestamp: ${data.timestamp}`);\n\n// Retornar dados para resposta\nreturn {\n  success: true,\n  status: 'sent',\n  user: data.user?.name,\n  phone: data.phone,\n  type: data.type,\n  timestamp: data.timestamp\n};"
      },
      "id": "log-success",
      "name": "ğŸ“ Log Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1240, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\\n  \"success\": true,\\n  \"message\": \"Mensagem WhatsApp enviada com sucesso! âœ…\",\\n  \"data\": {\\n    \"user\": $json.user,\\n    \"phone\": $json.phone,\\n    \"type\": $json.type,\\n    \"timestamp\": $json.timestamp\\n  }\\n}",
        "options": {}
      },
      "id": "success-response",
      "name": "âœ… Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1480, 200]
    },
    {
      "parameters": {
        "jsCode": "// Log de erro detalhado\nconst data = $input.first().json;\n\nconsole.log('âŒ ERRO - Dados invÃ¡lidos!');\nconsole.log(`ğŸ” Erro: ${data.error || 'Dados invÃ¡lidos'}`);\nconsole.log(`ğŸ“ Telefone: ${data.phone || 'nÃ£o fornecido'}`);\nconsole.log(`ğŸ‘¤ UsuÃ¡rio: ${data.user?.name || 'nÃ£o fornecido'}`);\nconsole.log(`ğŸ“§ Email: ${data.user?.email || 'nÃ£o fornecido'}`);\nconsole.log(`ğŸ“„ Dados originais:`, JSON.stringify(data.originalData, null, 2));\n\n// Retornar dados para resposta de erro\nreturn {\n  success: false,\n  error: data.error || 'Dados invÃ¡lidos',\n  phone: data.phone,\n  user: data.user?.name,\n  timestamp: data.timestamp\n};"
      },
      "id": "log-error",
      "name": "ğŸ“ Log Erro",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\\n  \"success\": false,\\n  \"message\": \"Falha no processamento dos dados âŒ\",\\n  \"error\": $json.error,\\n  \"data\": {\\n    \"phone\": $json.phone,\\n    \"user\": $json.user,\\n    \"timestamp\": $json.timestamp\\n  }\\n}",
        "options": {}
      },
      "id": "error-response",
      "name": "âŒ Erro",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1240, 400]
    },
    {
      "parameters": {
        "jsCode": "// Log de erro de envio\nconst originalData = $input.first().json;\nconst httpError = $input.first().error;\n\nconsole.log('âŒ ERRO DE ENVIO - WhatsApp falhou!');\nconsole.log(`ğŸ” Erro HTTP:`, httpError?.message || 'Erro desconhecido');\nconsole.log(`ğŸ“ Telefone: ${originalData.phone}`);\nconsole.log(`ğŸ‘¤ UsuÃ¡rio: ${originalData.user?.name}`);\nconsole.log(`ğŸ”§ URL da API: ${originalData.evolutionConfig?.apiUrl}`);\nconsole.log(`ğŸ·ï¸ InstÃ¢ncia: ${originalData.evolutionConfig?.instance}`);\n\n// Retornar dados para resposta de erro de envio\nreturn {\n  success: false,\n  error: 'Falha ao enviar WhatsApp',\n  details: httpError?.message || 'Erro na comunicaÃ§Ã£o com Evolution API',\n  phone: originalData.phone,\n  user: originalData.user?.name,\n  apiUrl: originalData.evolutionConfig?.apiUrl,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "log-send-error",
      "name": "ğŸ“ Log Erro Envio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1240, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\\n  \"success\": false,\\n  \"message\": \"Falha ao enviar WhatsApp âŒ\",\\n  \"error\": $json.error,\\n  \"details\": $json.details,\\n  \"data\": {\\n    \"phone\": $json.phone,\\n    \"user\": $json.user,\\n    \"apiUrl\": $json.apiUrl,\\n    \"timestamp\": $json.timestamp\\n  }\\n}",
        "options": {}
      },
      "id": "send-error-response",
      "name": "âŒ Erro Envio",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1480, 300]
    }
  ],
  "connections": {
    "ğŸ¯ Webhook PoupeJÃ¡": {
      "main": [
        [
          {
            "node": "âš™ï¸ Processar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ Processar Dados": {
      "main": [
        [
          {
            "node": "âœ… Dados VÃ¡lidos?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Dados VÃ¡lidos?": {
      "main": [
        [
          {
            "node": "ğŸ“² Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“ Log Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“² Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "ğŸ“ Log Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "ğŸ“ Log Erro Envio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Log Sucesso": {
      "main": [
        [
          {
            "node": "âœ… Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Log Erro": {
      "main": [
        [
          {
            "node": "âŒ Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Log Erro Envio": {
      "main": [
        [
          {
            "node": "âŒ Erro Envio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["poupeja", "whatsapp", "evolution-api"],
  "triggerCount": 1,
  "updatedAt": "2025-01-01T00:00:00.000Z",
  "versionId": "2.0.0"
}