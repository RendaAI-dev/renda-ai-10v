{
  "meta": {
    "instanceId": "poupeja-production"
  },
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "poupeja-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "8c0f8c8a-8c8a-4c8a-8c8a-8c8a8c8a8c8a",
      "name": "üéØ PoupeJ√° Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "poupeja-webhook-trigger"
    },
    {
      "parameters": {
        "jsCode": "// ===== PROCESSADOR DE DADOS POUPEJ√Å - N8N =====\n// Vers√£o: 2.0 - Completa e Otimizada\n\nconsole.log('=== IN√çCIO DO PROCESSAMENTO POUPEJ√Å ===');\n\n// Fun√ß√£o para logs detalhados\nfunction logDetalhado(nivel, titulo, dados = null) {\n  const timestamp = new Date().toISOString();\n  const logMsg = `[${timestamp}] [${nivel}] ${titulo}`;\n  console.log(logMsg);\n  if (dados) {\n    console.log('Dados:', JSON.stringify(dados, null, 2));\n  }\n}\n\ntry {\n  // === EXTRA√á√ÉO DOS DADOS DO WEBHOOK ===\n  logDetalhado('INFO', '1. Extraindo dados do webhook');\n  \n  let dadosEntrada;\n  \n  // Tentar diferentes fontes de dados\n  if ($input && $input.first() && $input.first().json) {\n    dadosEntrada = $input.first().json;\n    logDetalhado('INFO', 'Dados obtidos via $input.first().json');\n  } else if ($json) {\n    dadosEntrada = $json;\n    logDetalhado('INFO', 'Dados obtidos via $json');\n  } else {\n    throw new Error('Nenhum dado encontrado no webhook');\n  }\n  \n  logDetalhado('DEBUG', 'Dados brutos recebidos', dadosEntrada);\n  \n  // === VALIDA√á√ÉO B√ÅSICA DOS DADOS ===\n  logDetalhado('INFO', '2. Validando estrutura dos dados');\n  \n  if (!dadosEntrada || typeof dadosEntrada !== 'object') {\n    throw new Error('Dados inv√°lidos ou ausentes');\n  }\n  \n  // Extrair campos principais\n  const {\n    type = 'custom',\n    user = {},\n    data = {},\n    message = '',\n    metadata = {},\n    evolution_config = {}\n  } = dadosEntrada;\n  \n  logDetalhado('INFO', 'Campos extra√≠dos', { type, user: user.phone, message: message.substring(0, 50) });\n  \n  // === VALIDA√á√ÉO DO USU√ÅRIO ===\n  logDetalhado('INFO', '3. Validando dados do usu√°rio');\n  \n  if (!user.phone) {\n    throw new Error('Telefone do usu√°rio n√£o fornecido');\n  }\n  \n  // === NORMALIZA√á√ÉO DO TELEFONE BRASILEIRO ===\n  logDetalhado('INFO', '4. Normalizando telefone brasileiro');\n  \n  function normalizarTelefoneBrasil(telefone) {\n    if (!telefone) return null;\n    \n    // Remove todos os caracteres n√£o num√©ricos\n    let telefoneNumeros = telefone.replace(/[^0-9]/g, '');\n    \n    logDetalhado('DEBUG', 'Telefone ap√≥s limpeza', telefoneNumeros);\n    \n    // Remove c√≥digo do pa√≠s (55) se presente no in√≠cio\n    if (telefoneNumeros.startsWith('55') && telefoneNumeros.length >= 12) {\n      telefoneNumeros = telefoneNumeros.substring(2);\n      logDetalhado('DEBUG', 'Removido c√≥digo do pa√≠s 55', telefoneNumeros);\n    }\n    \n    // Verifica se tem DDD (2 d√≠gitos) + n√∫mero\n    if (telefoneNumeros.length === 10) {\n      // DDD + 8 d√≠gitos (celular sem 9¬∫ d√≠gito) - adicionar 9\n      const ddd = telefoneNumeros.substring(0, 2);\n      const numero = telefoneNumeros.substring(2);\n      telefoneNumeros = ddd + '9' + numero;\n      logDetalhado('DEBUG', 'Adicionado 9¬∫ d√≠gito', telefoneNumeros);\n    }\n    \n    // Adiciona c√≥digo do pa√≠s\n    if (telefoneNumeros.length === 11) {\n      telefoneNumeros = '55' + telefoneNumeros;\n      logDetalhado('DEBUG', 'Adicionado c√≥digo do pa√≠s', telefoneNumeros);\n    }\n    \n    // Valida√ß√£o final\n    if (telefoneNumeros.length !== 13) {\n      logDetalhado('WARN', 'Telefone com formato inv√°lido', { original: telefone, processado: telefoneNumeros });\n      return null;\n    }\n    \n    return telefoneNumeros;\n  }\n  \n  const telefoneNormalizado = normalizarTelefoneBrasil(user.phone);\n  \n  if (!telefoneNormalizado) {\n    throw new Error(`Telefone inv√°lido: ${user.phone}`);\n  }\n  \n  logDetalhado('INFO', 'Telefone normalizado com sucesso', { original: user.phone, normalizado: telefoneNormalizado });\n  \n  // === CONFIGURA√á√ÉO DA EVOLUTION API ===\n  logDetalhado('INFO', '5. Configurando Evolution API');\n  \n  const evolutionConfig = {\n    apiUrl: evolution_config.api_url || metadata.evolution_api_url || 'http://localhost:8080',\n    apiKey: evolution_config.api_key || metadata.evolution_api_key || '',\n    instance: evolution_config.instance || metadata.evolution_instance || 'poupeja'\n  };\n  \n  logDetalhado('INFO', 'Configura√ß√£o Evolution API', {\n    apiUrl: evolutionConfig.apiUrl,\n    instance: evolutionConfig.instance,\n    apiKeyPresente: !!evolutionConfig.apiKey\n  });\n  \n  // === CONSTRU√á√ÉO DA MENSAGEM PERSONALIZADA ===\n  logDetalhado('INFO', '6. Construindo mensagem personalizada');\n  \n  function construirMensagem(tipo, usuario, dados, mensagemCustom) {\n    const nome = usuario.name || 'Usu√°rio';\n    const emoji = {\n      'appointment_created': 'üìÖ',\n      'appointment_reminder': '‚è∞',\n      'transaction_due': 'üí∞',\n      'transaction_reminder': 'üí≥',\n      'goal_progress': 'üéØ',\n      'goal_achieved': 'üèÜ',\n      'budget_exceeded': '‚ö†Ô∏è',\n      'custom': 'üì¢'\n    };\n    \n    const emojiTipo = emoji[tipo] || 'üì¢';\n    \n    switch (tipo) {\n      case 'appointment_created':\n      case 'appointment_reminder':\n        return `${emojiTipo} *Lembrete de Compromisso*\\n\\n` +\n               `Ol√° ${nome}! üëã\\n\\n` +\n               `üìù *${dados.title || 'Compromisso'}*\\n` +\n               `üìÖ *Data:* ${dados.date ? new Date(dados.date).toLocaleDateString('pt-BR') : 'A definir'}\\n` +\n               `üïí *Hor√°rio:* ${dados.time || 'A definir'}\\n\\n` +\n               `${dados.description ? `üìã *Detalhes:* ${dados.description}\\n\\n` : ''}` +\n               `N√£o se esque√ßa! üòä\\n\\n` +\n               `_Enviado pelo PoupeJ√°_`;\n      \n      case 'transaction_due':\n      case 'transaction_reminder':\n        return `${emojiTipo} *Lembrete Financeiro*\\n\\n` +\n               `Ol√° ${nome}! üëã\\n\\n` +\n               `üí∞ *${dados.title || 'Transa√ß√£o'}*\\n` +\n               `üíµ *Valor:* R$ ${dados.amount ? Number(dados.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '0,00'}\\n` +\n               `üìÖ *Vencimento:* ${dados.date ? new Date(dados.date).toLocaleDateString('pt-BR') : 'Hoje'}\\n` +\n               `üè∑Ô∏è *Categoria:* ${dados.category || 'Geral'}\\n\\n` +\n               `${dados.description ? `üìã *Descri√ß√£o:* ${dados.description}\\n\\n` : ''}` +\n               `N√£o deixe para depois! üí™\\n\\n` +\n               `_Enviado pelo PoupeJ√°_`;\n      \n      case 'goal_progress':\n        const progresso = dados.progress || 0;\n        return `${emojiTipo} *Progresso da Meta*\\n\\n` +\n               `Ol√° ${nome}! üëã\\n\\n` +\n               `üéØ *${dados.title || 'Meta'}*\\n` +\n               `üìä *Progresso:* ${progresso}%\\n` +\n               `üí∞ *Valor atual:* R$ ${dados.current_amount ? Number(dados.current_amount).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '0,00'}\\n` +\n               `üéØ *Meta:* R$ ${dados.target_amount ? Number(dados.target_amount).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '0,00'}\\n\\n` +\n               `Continue assim! Voc√™ est√° no caminho certo! üöÄ\\n\\n` +\n               `_Enviado pelo PoupeJ√°_`;\n      \n      case 'goal_achieved':\n        return `${emojiTipo} *Meta Alcan√ßada!*\\n\\n` +\n               `Parab√©ns ${nome}! üéâ\\n\\n` +\n               `üèÜ *${dados.title || 'Meta'}*\\n` +\n               `üí∞ *Valor alcan√ßado:* R$ ${dados.achieved_amount ? Number(dados.achieved_amount).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '0,00'}\\n\\n` +\n               `Voc√™ conseguiu! Isso √© incr√≠vel! üåü\\n\\n` +\n               `Continue definindo novas metas e crescendo! üìà\\n\\n` +\n               `_Enviado pelo PoupeJ√°_`;\n      \n      case 'budget_exceeded':\n        const percentualExcesso = dados.exceeded_percent || 0;\n        return `${emojiTipo} *Or√ßamento Excedido*\\n\\n` +\n               `Aten√ß√£o ${nome}! ‚ö†Ô∏è\\n\\n` +\n               `üìä *Or√ßamento:* ${dados.budget_name || 'Geral'}\\n` +\n               `üí∏ *Excesso:* ${percentualExcesso}% acima do planejado\\n` +\n               `üí∞ *Valor excedido:* R$ ${dados.exceeded_amount ? Number(dados.exceeded_amount).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '0,00'}\\n\\n` +\n               `Que tal revisar seus gastos? ü§î\\n\\n` +\n               `_Enviado pelo PoupeJ√°_`;\n      \n      default:\n        return mensagemCustom || `${emojiTipo} *Notifica√ß√£o PoupeJ√°*\\n\\n` +\n               `Ol√° ${nome}! üëã\\n\\n` +\n               `${dados.title || 'Nova notifica√ß√£o'}\\n\\n` +\n               `${dados.description || 'Voc√™ tem uma nova notifica√ß√£o do PoupeJ√°.'}\\n\\n` +\n               `_Enviado pelo PoupeJ√°_`;\n    }\n  }\n  \n  const mensagemFinal = construirMensagem(type, user, data, message);\n  \n  logDetalhado('INFO', 'Mensagem constru√≠da', { tipo: type, tamanho: mensagemFinal.length });\n  \n  // === PREPARA√á√ÉO DOS DADOS DE SA√çDA ===\n  logDetalhado('INFO', '7. Preparando dados de sa√≠da');\n  \n  const dadosSaida = {\n    // Dados processados\n    processamento: {\n      sucesso: true,\n      timestamp: new Date().toISOString(),\n      tipo_evento: type,\n      telefone_original: user.phone,\n      telefone_normalizado: telefoneNormalizado,\n      deve_enviar: true\n    },\n    \n    // Dados do usu√°rio processados\n    usuario: {\n      id: user.id,\n      nome: user.name || 'Usu√°rio',\n      email: user.email,\n      telefone: telefoneNormalizado\n    },\n    \n    // Dados do evento\n    evento: {\n      tipo: type,\n      dados: data,\n      mensagem_personalizada: mensagemFinal\n    },\n    \n    // Configura√ß√£o Evolution API\n    evolution_api: {\n      url: evolutionConfig.apiUrl,\n      api_key: evolutionConfig.apiKey,\n      instance: evolutionConfig.instance,\n      endpoint_envio: `${evolutionConfig.apiUrl}/message/sendText/${evolutionConfig.instance}`\n    },\n    \n    // Payload para Evolution API\n    whatsapp_payload: {\n      number: telefoneNormalizado,\n      text: mensagemFinal\n    },\n    \n    // Metadados\n    metadata: {\n      ...metadata,\n      processado_em: new Date().toISOString(),\n      versao_processador: '2.0',\n      origem: 'poupeja-n8n-flow'\n    }\n  };\n  \n  logDetalhado('INFO', 'Dados de sa√≠da preparados', {\n    usuario_id: dadosSaida.usuario.id,\n    telefone: dadosSaida.usuario.telefone,\n    tipo_evento: dadosSaida.evento.tipo,\n    endpoint: dadosSaida.evolution_api.endpoint_envio\n  });\n  \n  console.log('=== PROCESSAMENTO CONCLU√çDO COM SUCESSO ===');\n  \n  return dadosSaida;\n  \n} catch (erro) {\n  logDetalhado('ERROR', 'Erro durante processamento', {\n    mensagem: erro.message,\n    stack: erro.stack\n  });\n  \n  // Retornar objeto de erro estruturado\n  return {\n    processamento: {\n      sucesso: false,\n      timestamp: new Date().toISOString(),\n      erro: {\n        mensagem: erro.message,\n        tipo: erro.name || 'ProcessingError',\n        detalhes: erro.stack\n      },\n      deve_enviar: false\n    },\n    erro_detalhes: {\n      dados_recebidos: $json || $input?.first()?.json || null,\n      contexto: 'processador_dados_poupeja'\n    }\n  };\n}"
      },
      "id": "9d1f9d9a-9d9a-4d9a-9d9a-9d9a9d9a9d9a",
      "name": "‚öôÔ∏è Processar Dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.processamento.sucesso }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            },
            {
              "id": "condition2",
              "leftValue": "={{ $json.processamento.deve_enviar }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            },
            {
              "id": "condition3",
              "leftValue": "={{ $json.usuario.telefone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ae2fae2f-ae2f-4e2f-ae2f-ae2fae2fae2f",
      "name": "‚úÖ Dados V√°lidos?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "// === CONFIGURADOR EVOLUTION API ===\n// Prepara configura√ß√µes finais para envio\n\nconsole.log('=== CONFIGURANDO EVOLUTION API ===');\n\ntry {\n  const dados = $json;\n  \n  console.log('Dados recebidos para configura√ß√£o:', JSON.stringify({\n    url: dados.evolution_api.url,\n    instance: dados.evolution_api.instance,\n    hasApiKey: !!dados.evolution_api.api_key,\n    telefone: dados.usuario.telefone\n  }, null, 2));\n  \n  // Validar configura√ß√µes obrigat√≥rias\n  if (!dados.evolution_api.url) {\n    throw new Error('URL da Evolution API n√£o configurada');\n  }\n  \n  if (!dados.evolution_api.instance) {\n    throw new Error('Inst√¢ncia da Evolution API n√£o configurada');\n  }\n  \n  // Construir headers\n  const headers = {\n    'Content-Type': 'application/json',\n    'Accept': 'application/json'\n  };\n  \n  // Adicionar API Key se dispon√≠vel\n  if (dados.evolution_api.api_key) {\n    headers['apikey'] = dados.evolution_api.api_key;\n    console.log('API Key adicionada aos headers');\n  }\n  \n  // Preparar configura√ß√£o final\n  const configuracao = {\n    ...dados,\n    evolution_final: {\n      url_completa: dados.evolution_api.endpoint_envio,\n      headers: headers,\n      payload: dados.whatsapp_payload,\n      timeout: 30000, // 30 segundos\n      retry_attempts: 2\n    }\n  };\n  \n  console.log('Configura√ß√£o Evolution API finalizada:', JSON.stringify({\n    url: configuracao.evolution_final.url_completa,\n    headers: Object.keys(configuracao.evolution_final.headers),\n    payload: configuracao.evolution_final.payload\n  }, null, 2));\n  \n  return configuracao;\n  \n} catch (erro) {\n  console.error('Erro na configura√ß√£o Evolution API:', erro.message);\n  \n  return {\n    ...$json,\n    processamento: {\n      ...$json.processamento,\n      sucesso: false,\n      erro: {\n        mensagem: erro.message,\n        tipo: 'EvolutionConfigError',\n        contexto: 'configurador_evolution_api'\n      },\n      deve_enviar: false\n    }\n  };\n}"
      },
      "id": "bf3fbf3f-bf3f-4f3f-bf3f-bf3fbf3fbf3f",
      "name": "üîß Configurar Evolution API",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.evolution_final.url_completa }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Accept", 
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "={{ $json.evolution_api.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": []
        },
        "jsonBody": "={{ JSON.stringify($json.evolution_final.payload) }}",
        "options": {
          "timeout": 30000,
          "retry": {
            "enabled": true,
            "maxAttempts": 2
          }
        }
      },
      "id": "c04fc04f-c04f-4c04-c04f-c04fc04fc04f",
      "name": "üì≤ Enviar WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "jsCode": "// === LOGGER DE SUCESSO ===\n// Registra envios bem-sucedidos\n\nconst timestamp = new Date().toISOString();\nconst dados = $('Processar Dados').first().json;\nconst resposta = $json;\n\nconsole.log('=== WHATSAPP ENVIADO COM SUCESSO ===');\nconsole.log('Timestamp:', timestamp);\nconsole.log('Usu√°rio:', dados.usuario.nome, '-', dados.usuario.telefone);\nconsole.log('Tipo evento:', dados.evento.tipo);\nconsole.log('Status Evolution API:', resposta.status || 'N/A');\nconsole.log('Response Evolution API:', JSON.stringify(resposta, null, 2));\n\n// Preparar dados para log estruturado\nconst logData = {\n  timestamp,\n  status: 'success',\n  evento: {\n    tipo: dados.evento.tipo,\n    usuario_id: dados.usuario.id,\n    usuario_nome: dados.usuario.nome,\n    usuario_telefone: dados.usuario.telefone\n  },\n  envio: {\n    evolution_status: resposta.status,\n    evolution_response: resposta,\n    mensagem_tamanho: dados.evento.mensagem_personalizada.length,\n    endpoint_usado: dados.evolution_api.endpoint_envio\n  },\n  performance: {\n    processamento_iniciado: dados.processamento.timestamp,\n    envio_concluido: timestamp,\n    duracao_total: new Date(timestamp) - new Date(dados.processamento.timestamp)\n  }\n};\n\nconsole.log('Log estruturado:', JSON.stringify(logData, null, 2));\n\nreturn {\n  success: true,\n  message: 'WhatsApp enviado com sucesso',\n  log_data: logData,\n  original_data: dados\n};"
      },
      "id": "d05fd05f-d05f-4d05-d05f-d05fd05fd05f",
      "name": "üìä Log Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 200]
    },
    {
      "parameters": {
        "jsCode": "// === LOGGER DE ERRO DE PROCESSAMENTO ===\n// Registra erros durante processamento de dados\n\nconst timestamp = new Date().toISOString();\nconst dados = $json;\n\nconsole.log('=== ERRO NO PROCESSAMENTO DE DADOS ===');\nconsole.log('Timestamp:', timestamp);\nconsole.log('Erro:', dados.processamento.erro.mensagem);\nconsole.log('Tipo erro:', dados.processamento.erro.tipo);\nconsole.log('Dados recebidos:', JSON.stringify(dados.erro_detalhes.dados_recebidos, null, 2));\n\n// Preparar dados para log de erro\nconst logError = {\n  timestamp,\n  status: 'error',\n  error_type: 'processing_error',\n  error: {\n    message: dados.processamento.erro.mensagem,\n    type: dados.processamento.erro.tipo,\n    details: dados.processamento.erro.detalhes\n  },\n  context: {\n    dados_recebidos: dados.erro_detalhes.dados_recebidos,\n    contexto: dados.erro_detalhes.contexto\n  }\n};\n\nconsole.log('Log de erro estruturado:', JSON.stringify(logError, null, 2));\n\nreturn {\n  success: false,\n  error_type: 'processing_error',\n  message: 'Erro no processamento dos dados',\n  log_data: logError,\n  original_data: dados\n};"
      },
      "id": "e06fe06f-e06f-4e06-e06f-e06fe06fe06f",
      "name": "üìù Log Erro Processamento",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "jsCode": "// === LOGGER DE ERRO DE ENVIO ===\n// Registra erros durante envio WhatsApp\n\nconst timestamp = new Date().toISOString();\nconst dadosOriginais = $('Processar Dados').first().json;\nconst erro = $json;\n\nconsole.log('=== ERRO NO ENVIO WHATSAPP ===');\nconsole.log('Timestamp:', timestamp);\nconsole.log('Usu√°rio:', dadosOriginais.usuario.nome, '-', dadosOriginais.usuario.telefone);\nconsole.log('Erro HTTP:', erro.message || 'Erro desconhecido');\nconsole.log('Status code:', erro.httpCode || 'N/A');\nconsole.log('Response:', JSON.stringify(erro, null, 2));\n\n// Preparar dados para log de erro de envio\nconst logError = {\n  timestamp,\n  status: 'error',\n  error_type: 'sending_error',\n  evento: {\n    tipo: dadosOriginais.evento.tipo,\n    usuario_id: dadosOriginais.usuario.id,\n    usuario_nome: dadosOriginais.usuario.nome,\n    usuario_telefone: dadosOriginais.usuario.telefone\n  },\n  error: {\n    message: erro.message || 'Erro no envio WhatsApp',\n    http_code: erro.httpCode,\n    response: erro,\n    endpoint: dadosOriginais.evolution_api.endpoint_envio\n  },\n  performance: {\n    processamento_iniciado: dadosOriginais.processamento.timestamp,\n    erro_ocorrido: timestamp,\n    duracao_ate_erro: new Date(timestamp) - new Date(dadosOriginais.processamento.timestamp)\n  }\n};\n\nconsole.log('Log de erro de envio estruturado:', JSON.stringify(logError, null, 2));\n\nreturn {\n  success: false,\n  error_type: 'sending_error',\n  message: 'Erro no envio WhatsApp',\n  log_data: logError,\n  original_data: dadosOriginais\n};"
      },
      "id": "f07ff07f-f07f-4f07-f07f-f07ff07ff07f",
      "name": "üìù Log Erro Envio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  success: true,\n  message: 'WhatsApp enviado com sucesso',\n  timestamp: new Date().toISOString(),\n  data: {\n    usuario: $json.original_data.usuario.nome,\n    telefone: $json.original_data.usuario.telefone,\n    tipo_evento: $json.original_data.evento.tipo,\n    evolution_status: 'sent'\n  }\n}) }}",
        "options": {}
      },
      "id": "10811081-1081-4108-1081-108110811081",
      "name": "‚úÖ Resposta Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1560, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  success: false,\n  error: 'Erro no processamento dos dados',\n  message: $json.log_data.error.message,\n  timestamp: new Date().toISOString(),\n  details: {\n    error_type: $json.error_type,\n    context: 'data_processing'\n  }\n}) }}",
        "responseCode": 400,
        "options": {}
      },
      "id": "11911191-1191-4119-1191-119111911191",
      "name": "‚ùå Resposta Erro Processamento",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1120, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  success: false,\n  error: 'Erro no envio WhatsApp',\n  message: $json.log_data.error.message,\n  timestamp: new Date().toISOString(),\n  details: {\n    error_type: $json.error_type,\n    http_code: $json.log_data.error.http_code,\n    context: 'whatsapp_sending'\n  }\n}) }}",
        "responseCode": 500,
        "options": {}
      },
      "id": "12a12a12-12a1-412a-12a1-12a12a12a12a",
      "name": "‚ùå Resposta Erro Envio",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1560, 400]
    }
  ],
  "connections": {
    "üéØ PoupeJ√° Webhook": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è Processar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è Processar Dados": {
      "main": [
        [
          {
            "node": "‚úÖ Dados V√°lidos?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ Dados V√°lidos?": {
      "main": [
        [
          {
            "node": "üîß Configurar Evolution API",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üìù Log Erro Processamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîß Configurar Evolution API": {
      "main": [
        [
          {
            "node": "üì≤ Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì≤ Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "üìä Log Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "üìù Log Erro Envio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Log Sucesso": {
      "main": [
        [
          {
            "node": "‚úÖ Resposta Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Log Erro Processamento": {
      "main": [
        [
          {
            "node": "‚ùå Resposta Erro Processamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Log Erro Envio": {
      "main": [
        [
          {
            "node": "‚ùå Resposta Erro Envio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {}
}