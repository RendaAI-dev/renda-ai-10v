{
  "name": "PoupeJÃ¡ MCP + OpenAI + Supabase Flow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "poupeja-mcp-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "ğŸ¯ Webhook PoupeJÃ¡ MCP",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "poupeja-mcp-webhook"
    },
    {
      "parameters": {
        "jsCode": "// ğŸ“¥ PROCESSAMENTO INICIAL DOS DADOS\nconst payload = $json;\nconsole.log('ğŸ“¥ Payload recebido:', JSON.stringify(payload, null, 2));\n\n// ValidaÃ§Ã£o bÃ¡sica do payload\nif (!payload || !payload.user) {\n  throw new Error('âŒ Payload invÃ¡lido: dados do usuÃ¡rio ausentes');\n}\n\nconst userData = payload.user;\nconst eventData = payload.data || {};\nconst eventType = payload.type || 'custom';\n\nconsole.log('ğŸ‘¤ Dados do usuÃ¡rio:', userData);\nconsole.log('ğŸ“Š Tipo de evento:', eventType);\nconsole.log('ğŸ“‹ Dados do evento:', eventData);\n\n// Normalizar telefone brasileiro\nfunction normalizeBrazilianPhone(phone) {\n  if (!phone) return null;\n  \n  // Remove todos os caracteres nÃ£o numÃ©ricos\n  let cleanPhone = phone.replace(/\\D/g, '');\n  console.log('ğŸ“± Telefone limpo:', cleanPhone);\n  \n  // Remove cÃ³digo do paÃ­s 55 se presente\n  if (cleanPhone.startsWith('55')) {\n    cleanPhone = cleanPhone.substring(2);\n    console.log('ğŸ“± ApÃ³s remover 55:', cleanPhone);\n  }\n  \n  // Adiciona 9Âº dÃ­gito se necessÃ¡rio (DDD + 8 dÃ­gitos = celular)\n  if (cleanPhone.length === 10 && ['6', '7', '8', '9'].includes(cleanPhone.charAt(2))) {\n    cleanPhone = cleanPhone.substring(0, 2) + '9' + cleanPhone.substring(2);\n    console.log('ğŸ“± ApÃ³s adicionar 9Âº dÃ­gito:', cleanPhone);\n  }\n  \n  // Adiciona cÃ³digo do paÃ­s\n  if (cleanPhone.length === 11) {\n    cleanPhone = '55' + cleanPhone;\n    console.log('ğŸ“± Telefone final:', cleanPhone);\n  }\n  \n  // ValidaÃ§Ã£o final\n  if (cleanPhone.length !== 13) {\n    console.warn('âš ï¸ Telefone com formato invÃ¡lido:', cleanPhone);\n    return null;\n  }\n  \n  return cleanPhone;\n}\n\nconst normalizedPhone = normalizeBrazilianPhone(userData.phone);\nif (!normalizedPhone) {\n  throw new Error('âŒ Telefone invÃ¡lido ou ausente');\n}\n\n// ConfiguraÃ§Ã£o da Evolution API do payload\nconst evolutionConfig = payload.metadata?.evolutionApi || {};\n\n// Preparar dados para prÃ³ximo node\nconst processedData = {\n  user: {\n    id: userData.id,\n    name: userData.name,\n    email: userData.email,\n    phone: normalizedPhone\n  },\n  event: {\n    type: eventType,\n    data: eventData,\n    timestamp: new Date().toISOString()\n  },\n  evolution: {\n    apiUrl: evolutionConfig.apiUrl || 'https://evolution-api.example.com',\n    apiKey: evolutionConfig.apiKey || '',\n    instance: evolutionConfig.instance || 'default'\n  },\n  originalPayload: payload\n};\n\nconsole.log('âœ… Dados processados com sucesso:', JSON.stringify(processedData, null, 2));\n\nreturn processedData;"
      },
      "id": "data_processor",
      "name": "âš™ï¸ Processador de Dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// ğŸ” BUSCAR DADOS CONTEXTUAIS NO SUPABASE\nconst data = $json;\nconst userId = data.user.id;\n\nconsole.log('ğŸ” Buscando dados contextuais para usuÃ¡rio:', userId);\n\n// Preparar queries para buscar dados do usuÃ¡rio\nconst supabaseQueries = {\n  // Dados do perfil do usuÃ¡rio\n  userProfile: {\n    table: 'poupeja_users',\n    select: 'name, email, phone, profile_image',\n    filter: `id=eq.${userId}`\n  },\n  \n  // Ãšltimas transaÃ§Ãµes (Ãºltimos 30 dias)\n  recentTransactions: {\n    table: 'poupeja_transactions',\n    select: 'id, type, amount, description, date, created_at',\n    filter: `user_id=eq.${userId}&date=gte.${new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0]}`,\n    order: 'date.desc',\n    limit: 10\n  },\n  \n  // Metas ativas\n  activeGoals: {\n    table: 'poupeja_goals',\n    select: 'id, name, target_amount, current_amount, deadline',\n    filter: `user_id=eq.${userId}&deadline=gte.${new Date().toISOString().split('T')[0]}`,\n    order: 'deadline.asc'\n  },\n  \n  // OrÃ§amentos ativos\n  activeBudgets: {\n    table: 'poupeja_budgets',\n    select: 'id, amount, period, start_date, end_date',\n    filter: `user_id=eq.${userId}&end_date=gte.${new Date().toISOString().split('T')[0]}`\n  },\n  \n  // Categorias do usuÃ¡rio\n  userCategories: {\n    table: 'poupeja_categories',\n    select: 'id, name, type, color, icon',\n    filter: `user_id=eq.${userId}`\n  }\n};\n\n// Preparar dados para o prÃ³ximo node (Supabase Fetcher)\nconst contextData = {\n  ...data,\n  supabaseQueries,\n  contextNeeded: true\n};\n\nconsole.log('ğŸ“Š Queries preparadas:', Object.keys(supabaseQueries));\n\nreturn contextData;"
      },
      "id": "context_builder",
      "name": "ğŸ§  Construtor de Contexto",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "// ğŸ“š SIMULAÃ‡ÃƒO DE DADOS DO SUPABASE (MOCK)\n// Em um cenÃ¡rio real, aqui vocÃª faria as queries reais no Supabase\nconst data = $json;\nconst userId = data.user.id;\n\nconsole.log('ğŸ“š Simulando busca de dados contextuais para usuÃ¡rio:', userId);\n\n// Mock de dados realistas baseados no esquema do Supabase\nconst mockContextData = {\n  userProfile: {\n    name: data.user.name,\n    email: data.user.email,\n    phone: data.user.phone,\n    profile_image: null\n  },\n  \n  recentTransactions: [\n    {\n      id: 'trans_001',\n      type: 'expense',\n      amount: -150.50,\n      description: 'Supermercado',\n      date: new Date(Date.now() - 2*24*60*60*1000).toISOString().split('T')[0]\n    },\n    {\n      id: 'trans_002', \n      type: 'income',\n      amount: 3500.00,\n      description: 'SalÃ¡rio',\n      date: new Date(Date.now() - 5*24*60*60*1000).toISOString().split('T')[0]\n    },\n    {\n      id: 'trans_003',\n      type: 'expense', \n      amount: -85.30,\n      description: 'CombustÃ­vel',\n      date: new Date(Date.now() - 7*24*60*60*1000).toISOString().split('T')[0]\n    }\n  ],\n  \n  activeGoals: [\n    {\n      id: 'goal_001',\n      name: 'Viagem para Europa',\n      target_amount: 8000.00,\n      current_amount: 2350.00,\n      deadline: new Date(Date.now() + 180*24*60*60*1000).toISOString().split('T')[0]\n    },\n    {\n      id: 'goal_002',\n      name: 'Reserva de EmergÃªncia',\n      target_amount: 10000.00,\n      current_amount: 4200.00,\n      deadline: new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0]\n    }\n  ],\n  \n  activeBudgets: [\n    {\n      id: 'budget_001',\n      amount: 1500.00,\n      period: 'monthly',\n      start_date: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0],\n      end_date: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).toISOString().split('T')[0]\n    }\n  ],\n  \n  userCategories: [\n    { id: 'cat_001', name: 'AlimentaÃ§Ã£o', type: 'expense', color: '#EF4444', icon: 'utensils' },\n    { id: 'cat_002', name: 'Transporte', type: 'expense', color: '#3B82F6', icon: 'car' },\n    { id: 'cat_003', name: 'SalÃ¡rio', type: 'income', color: '#10B981', icon: 'briefcase' }\n  ]\n};\n\n// Combinar dados originais com contexto\nconst enrichedData = {\n  ...data,\n  context: mockContextData,\n  contextFetched: true\n};\n\nconsole.log('âœ… Contexto simulado criado com sucesso');\nconsole.log('ğŸ“Š TransaÃ§Ãµes recentes:', mockContextData.recentTransactions.length);\nconsole.log('ğŸ¯ Metas ativas:', mockContextData.activeGoals.length);\nconsole.log('ğŸ’° OrÃ§amentos ativos:', mockContextData.activeBudgets.length);\n\nreturn enrichedData;"
      },
      "id": "supabase_fetcher",
      "name": "ğŸ—„ï¸ Buscar Dados Supabase",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "// ğŸ¤– PREPARAR PROMPT PARA OPENAI COM CONTEXTO MCP\nconst data = $json;\nconst user = data.user;\nconst event = data.event;\nconst context = data.context;\n\nconsole.log('ğŸ¤– Preparando prompt para OpenAI...');\n\n// Construir contexto rico para o AI\nconst userContext = `\n**PERFIL DO USUÃRIO:**\n- Nome: ${user.name}\n- Email: ${user.email}\n- ID: ${user.id}\n\n**SITUAÃ‡ÃƒO FINANCEIRA ATUAL:**\n- TransaÃ§Ãµes recentes (${context.recentTransactions.length} transaÃ§Ãµes):\n${context.recentTransactions.map(t => \n  `  â€¢ ${t.date}: ${t.type === 'income' ? '+' : ''}R$ ${t.amount.toFixed(2)} - ${t.description}`\n).join('\\n')}\n\n**METAS FINANCEIRAS:**\n${context.activeGoals.map(g => \n  `  â€¢ ${g.name}: R$ ${g.current_amount.toFixed(2)} / R$ ${g.target_amount.toFixed(2)} (${((g.current_amount/g.target_amount)*100).toFixed(1)}%) - Prazo: ${g.deadline}`\n).join('\\n')}\n\n**ORÃ‡AMENTOS ATIVOS:**\n${context.activeBudgets.map(b => \n  `  â€¢ ${b.period}: R$ ${b.amount.toFixed(2)} (${b.start_date} atÃ© ${b.end_date})`\n).join('\\n')}\n`;\n\n// Determinar o tipo de mensagem baseado no evento\nlet eventDescription = '';\nlet messagePurpose = '';\n\nswitch(event.type) {\n  case 'appointment_created':\n  case 'appointment_reminder':\n    eventDescription = `Compromisso: ${event.data.title} em ${event.data.date}`;\n    messagePurpose = 'lembrete de compromisso';\n    break;\n    \n  case 'transaction_due':\n  case 'transaction_reminder':\n    eventDescription = `TransaÃ§Ã£o pendente: ${event.data.description} - R$ ${event.data.amount}`;\n    messagePurpose = 'lembrete de pagamento';\n    break;\n    \n  case 'goal_progress':\n    eventDescription = `Progresso na meta: ${event.data.title}`;\n    messagePurpose = 'atualizaÃ§Ã£o de progresso de meta';\n    break;\n    \n  case 'goal_achieved':\n    eventDescription = `Meta alcanÃ§ada: ${event.data.title}`;\n    messagePurpose = 'parabenizaÃ§Ã£o por meta alcanÃ§ada';\n    break;\n    \n  case 'budget_exceeded':\n    eventDescription = `OrÃ§amento excedido em: ${event.data.category}`;\n    messagePurpose = 'alerta de orÃ§amento';\n    break;\n    \n  default:\n    eventDescription = event.data.description || 'Evento personalizado';\n    messagePurpose = 'mensagem personalizada';\n}\n\n// Prompt principal para o OpenAI\nconst systemPrompt = `VocÃª Ã© o PoupeJÃ¡ AI, um assistente financeiro inteligente e amigÃ¡vel do aplicativo PoupeJÃ¡.\n\nSua funÃ§Ã£o Ã© criar mensagens personalizadas via WhatsApp para os usuÃ¡rios com base em seus dados financeiros e contexto pessoal.\n\n**DIRETRIZES:**\n1. Seja amigÃ¡vel, motivador e Ãºtil\n2. Use linguagem informal e brasileira\n3. Personalize a mensagem usando o contexto do usuÃ¡rio\n4. Mantenha a mensagem concisa (mÃ¡ximo 200 caracteres)\n5. Use emojis apropriados mas sem exagerar\n6. Inclua insights Ãºteis baseados nos dados do usuÃ¡rio\n7. Seja especÃ­fico sobre valores e datas quando relevante\n8. Motive o usuÃ¡rio a continuar usando o PoupeJÃ¡\n\n**CONTEXTO DO USUÃRIO:**\n${userContext}\n\n**EVENTO ATUAL:**\n${eventDescription}\n\n**OBJETIVO DA MENSAGEM:**\nCriar um ${messagePurpose} personalizado e motivador.`;\n\nconst userPrompt = `Com base no contexto fornecido, crie uma mensagem personalizada para ${user.name} sobre: ${eventDescription}\n\nA mensagem deve ser:\n- Personalizada com base nos dados financeiros do usuÃ¡rio\n- Motivadora e Ãºtil\n- Concisa (mÃ¡ximo 200 caracteres)\n- Em portuguÃªs brasileiro informal\n- Com emojis apropriados\n\nRetorne APENAS a mensagem, sem aspas ou formataÃ§Ã£o adicional.`;\n\n// Preparar dados para OpenAI\nconst openaiData = {\n  ...data,\n  openai: {\n    systemPrompt,\n    userPrompt,\n    model: 'gpt-4o-mini',\n    maxTokens: 150,\n    temperature: 0.7\n  }\n};\n\nconsole.log('âœ… Prompt preparado para OpenAI');\nconsole.log('ğŸ“ Tamanho do contexto:', userContext.length, 'caracteres');\nconsole.log('ğŸ¯ Objetivo:', messagePurpose);\n\nreturn openaiData;"
      },
      "id": "ai_prompt_builder",
      "name": "ğŸ“ Construtor de Prompt IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "// ğŸ¤– SIMULAR RESPOSTA DO OPENAI\n// Em um cenÃ¡rio real, aqui vocÃª faria a chamada para a API do OpenAI\nconst data = $json;\nconst openaiConfig = data.openai;\nconst user = data.user;\nconst event = data.event;\n\nconsole.log('ğŸ¤– Simulando chamada para OpenAI...');\nconsole.log('ğŸ“‹ Modelo:', openaiConfig.model);\nconsole.log('ğŸŒ¡ï¸ Temperature:', openaiConfig.temperature);\n\n// Simular diferentes tipos de mensagens baseadas no evento\nlet aiGeneratedMessage = '';\n\nswitch(event.type) {\n  case 'appointment_created':\n  case 'appointment_reminder':\n    aiGeneratedMessage = `Oi ${user.name.split(' ')[0]}! ğŸ“… Lembrete: vocÃª tem \"${event.data.title}\" hoje. NÃ£o esqueÃ§a de registrar os gastos no PoupeJÃ¡ depois! ğŸ’™`;\n    break;\n    \n  case 'transaction_due':\n  case 'transaction_reminder':\n    aiGeneratedMessage = `${user.name.split(' ')[0]}, estÃ¡ na hora! ğŸ’³ ${event.data.description || 'Pagamento'} de R$ ${event.data.amount || '0,00'} vence hoje. JÃ¡ estÃ¡ no seu orÃ§amento? ğŸ“Š`;\n    break;\n    \n  case 'goal_progress':\n    const progress = event.data.progress || 0;\n    aiGeneratedMessage = `ğŸ‰ ParabÃ©ns ${user.name.split(' ')[0]}! VocÃª estÃ¡ ${progress}% mais perto da sua meta \"${event.data.title}\". Continue assim! ğŸ’ª`;\n    break;\n    \n  case 'goal_achieved':\n    aiGeneratedMessage = `ğŸ† INCRÃVEL! ${user.name.split(' ')[0]}, vocÃª conquistou sua meta \"${event.data.title}\"! Que tal criar uma nova meta no PoupeJÃ¡? ğŸš€`;\n    break;\n    \n  case 'budget_exceeded':\n    aiGeneratedMessage = `âš ï¸ Opa ${user.name.split(' ')[0]}! Seu orÃ§amento de ${event.data.category || 'categoria'} passou do limite. Que tal revisar os gastos no PoupeJÃ¡? ğŸ“±`;\n    break;\n    \n  default:\n    aiGeneratedMessage = `Oi ${user.name.split(' ')[0]}! ğŸ‘‹ ${event.data.description || 'Temos uma atualizaÃ§Ã£o para vocÃª no PoupeJÃ¡!'} Confira o app! ğŸ“±ğŸ’™`;\n}\n\n// Simular delay da API (500ms)\nconst delay = 500;\nconsole.log(`â±ï¸ Simulando delay de ${delay}ms...`);\n\n// Preparar resposta\nconst aiResponse = {\n  ...data,\n  aiMessage: aiGeneratedMessage,\n  aiProcessed: true,\n  processingTime: delay,\n  messageLength: aiGeneratedMessage.length\n};\n\nconsole.log('âœ… Mensagem IA gerada:', aiGeneratedMessage);\nconsole.log('ğŸ“ Tamanho da mensagem:', aiGeneratedMessage.length, 'caracteres');\n\nreturn aiResponse;"
      },
      "id": "openai_generator",
      "name": "ğŸ¤– Gerador OpenAI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.aiProcessed}}",
              "value2": true
            }
          ]
        }
      },
      "id": "ai_validator",
      "name": "âœ… Validar IA",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "url": "={{$json.evolution.apiUrl}}/message/sendText/{{$json.evolution.instance}}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "httpHeaderAuth": {
          "name": "apikey",
          "value": "={{$json.evolution.apiKey}}"
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{$json.user.phone}}"
            },
            {
              "name": "text",
              "value": "={{$json.aiMessage}}"
            }
          ]
        },
        "options": {
          "timeout": 30000,
          "retry": {
            "enabled": true,
            "maxTries": 3
          }
        }
      },
      "id": "whatsapp_sender",
      "name": "ğŸ“² Enviar WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1780, 240]
    },
    {
      "parameters": {
        "jsCode": "// ğŸ“Š LOG DE SUCESSO COMPLETO\nconst data = $json;\nconst response = data;\n\nconst successLog = {\n  timestamp: new Date().toISOString(),\n  status: 'success',\n  user: {\n    id: data.user.id,\n    name: data.user.name,\n    phone: data.user.phone\n  },\n  event: {\n    type: data.event.type,\n    data: data.event.data\n  },\n  message: {\n    content: data.aiMessage,\n    length: data.aiMessage.length,\n    generated_by: 'openai',\n    model: data.openai?.model || 'simulated'\n  },\n  whatsapp: {\n    status: response.status || 200,\n    instance: data.evolution.instance,\n    api_url: data.evolution.apiUrl\n  },\n  processing: {\n    total_time_ms: Date.now() - new Date(data.event.timestamp).getTime(),\n    ai_processing_time_ms: data.processingTime || 0\n  }\n};\n\nconsole.log('âœ… SUCESSO - Mensagem enviada com sucesso!');\nconsole.log('ğŸ“Š Log completo:', JSON.stringify(successLog, null, 2));\nconsole.log('ğŸ‘¤ UsuÃ¡rio:', data.user.name);\nconsole.log('ğŸ“± Telefone:', data.user.phone);\nconsole.log('ğŸ’¬ Mensagem:', data.aiMessage);\nconsole.log('ğŸ• Tempo total:', successLog.processing.total_time_ms, 'ms');\n\nreturn {\n  success: true,\n  log: successLog,\n  response: 'Mensagem enviada com sucesso via WhatsApp'\n};"
      },
      "id": "success_logger",
      "name": "ğŸ“Š Log Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 240]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ \n  {\n    \"success\": true,\n    \"message\": \"Mensagem AI personalizada enviada com sucesso\",\n    \"data\": {\n      \"user_id\": $json.user.id,\n      \"phone\": $json.user.phone,\n      \"message_sent\": $json.aiMessage,\n      \"event_type\": $json.event.type,\n      \"timestamp\": $json.log.timestamp,\n      \"processing_time_ms\": $json.log.processing.total_time_ms\n    }\n  }\n}}",
        "options": {}
      },
      "id": "success_response",
      "name": "âœ… Resposta Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2220, 240]
    },
    {
      "parameters": {
        "jsCode": "// âŒ LOG DE ERRO COMPLETO\nconst error = $json.error || 'Erro desconhecido';\nconst data = $input.all()[0]?.json || {};\n\nconst errorLog = {\n  timestamp: new Date().toISOString(),\n  status: 'error',\n  error: {\n    message: error.message || error,\n    type: error.name || 'Unknown Error',\n    stack: error.stack || null\n  },\n  user: {\n    id: data.user?.id || 'unknown',\n    name: data.user?.name || 'unknown',\n    phone: data.user?.phone || 'unknown'\n  },\n  event: {\n    type: data.event?.type || 'unknown',\n    data: data.event?.data || {}\n  },\n  context: {\n    step_failed: 'ai_validation_or_whatsapp_sending',\n    ai_processed: data.aiProcessed || false,\n    message_generated: !!data.aiMessage\n  }\n};\n\nconsole.error('âŒ ERRO - Falha no processamento!');\nconsole.error('ğŸš¨ Detalhes do erro:', JSON.stringify(errorLog, null, 2));\nconsole.error('ğŸ‘¤ UsuÃ¡rio afetado:', data.user?.name || 'Desconhecido');\nconsole.error('ğŸ“± Telefone:', data.user?.phone || 'Desconhecido');\nconsole.error('ğŸ” Etapa que falhou:', errorLog.context.step_failed);\n\nreturn {\n  success: false,\n  error: errorLog,\n  response: 'Falha no processamento da mensagem IA'\n};"
      },
      "id": "error_logger",
      "name": "âŒ Log Erro",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 380]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ \n  {\n    \"success\": false,\n    \"message\": \"Erro no processamento da mensagem IA\",\n    \"error\": {\n      \"type\": $json.error.error.type,\n      \"message\": $json.error.error.message,\n      \"timestamp\": $json.error.timestamp,\n      \"user_id\": $json.error.user.id,\n      \"step_failed\": $json.error.context.step_failed\n    }\n  }\n}}",
        "options": {}
      },
      "id": "error_response", 
      "name": "âŒ Resposta Erro",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 380]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "data_processor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "data_processor": {
      "main": [
        [
          {
            "node": "context_builder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "context_builder": {
      "main": [
        [
          {
            "node": "supabase_fetcher",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "supabase_fetcher": {
      "main": [
        [
          {
            "node": "ai_prompt_builder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ai_prompt_builder": {
      "main": [
        [
          {
            "node": "openai_generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "openai_generator": {
      "main": [
        [
          {
            "node": "ai_validator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ai_validator": {
      "main": [
        [
          {
            "node": "whatsapp_sender",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "error_logger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "whatsapp_sender": {
      "main": [
        [
          {
            "node": "success_logger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "success_logger": {
      "main": [
        [
          {
            "node": "success_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error_logger": {
      "main": [
        [
          {
            "node": "error_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-27T00:00:00.000Z",
  "versionId": "1"
}